name: Create Raydium Platform

on:
  workflow_dispatch: {}

jobs:
  create-platform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup pnpm (pre-cache guard)
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Ensure pnpm (composite)
        uses: ./.github/actions/ensure-pnpm

      - name: Install dependencies (root)
        run: pnpm install --frozen-lockfile

      # --- IMPORTANT: install the SDK where the script lives ---
      - name: Install Raydium SDK deps (fun-launch)
        working-directory: scaffolds/fun-launch
        run: |
          pnpm add -D @raydium-io/raydium-sdk-v2 @solana/spl-token bs58

      # (Optional) sanitize registry
      - name: Sanitize npm registries (optional)
        run: |
          echo "registry=https://registry.npmjs.org/" > ~/.npmrc
          pnpm config set registry https://registry.npmjs.org/
          npm config set registry https://registry.npmjs.org/

      - name: Run create-platform script
        id: run_script
        env:
          RPC_URL: ${{ secrets.RPC_URL }}
          RAYDIUM_PLATFORM_AUTHORITY_SECRET: ${{ secrets.RAYDIUM_PLATFORM_AUTHORITY_SECRET }}

          # Fees
          RAYDIUM_SHARE_FEE_BPS: '175'
          RAYDIUM_CREATION_FEE_LAMPORTS: '25000000'

          # LP split (must total 10000)
          RAYDIUM_MIGRATE_SPLIT_PLATFORM_BPS: '0'
          RAYDIUM_MIGRATE_SPLIT_CREATOR_BPS: '10000'
          RAYDIUM_MIGRATE_SPLIT_BURN_BPS: '0'

          RAYDIUM_LOCK_LP: 'false'
          NEXT_PUBLIC_SITE_NAME: 'Your LaunchPad'
          PUBLIC_BUCKET_URL: ''
          R2_PUBLIC_BASE: ''
        run: |
          set -eo pipefail
          pnpm dlx tsx scaffolds/fun-launch/scripts/raydium/create-platform.ts | tee script.log
          PDA_LINE="$(grep -m1 -E 'Platform PDA:' script.log || true)"
          if [ -n "$PDA_LINE" ]; then
            echo "$PDA_LINE" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Platform PDA not found in output. Check logs." >> "$GITHUB_STEP_SUMMARY"
          fi
